---
import { t, type Lang } from '../i18n/translations';
import DeviceAnimation from './DeviceAnimation.astro';
import MergeVisualization from './MergeVisualization.astro';
import CodeBlock from './CodeBlock.astro';
import InteractiveDemo from './InteractiveDemo.tsx';

interface Props { lang: Lang; }
const { lang } = Astro.props;

function colorClasses(color: string, prefix: string) {
  if (color === 'teal') return prefix === 'icon' ? 'bg-teal/10 text-teal' : 'bg-teal';
  if (color === 'orange') return prefix === 'icon' ? 'bg-orange/10 text-orange' : 'bg-orange';
  return prefix === 'icon' ? 'bg-purple/10 text-purple' : 'bg-purple';
}

const k = (v: string) => `<span class="syn-k">${v}</span>`;
const s = (v: string) => `<span class="syn-s">${v}</span>`;
const n = (v: string) => `<span class="syn-n">${v}</span>`;
const c = (v: string) => `<span class="syn-c">${v}</span>`;
const p = (v: string) => `<span class="syn-p">${v}</span>`;
const ty = (v: string) => `<span class="syn-t">${v}</span>`;

const codeCargoToml = `${k('[dependencies]')}\ncrdt-kit = ${s('"0.3"')}`;

const codeMainRs = [
  `${k('use')} crdt_kit::prelude::*;`,
  '',
  `${c('// Two devices, working offline')}`,
  `${k('let mut')} phone = GCounter::new(${s('"phone"')});`,
  'phone.increment();',
  'phone.increment();',
  '',
  `${k('let mut')} laptop = GCounter::new(${s('"laptop"')});`,
  'laptop.increment();',
  '',
  `${c('// Reconnect &mdash; merge. Always converges.')}`,
  `phone.merge(&amp;laptop);`,
  `${k('assert_eq!')}(phone.value(), ${n('3')});`,
].join('\n');

const codeDeltaSync = [
  `${k('let mut')} sensor = GCounter::new(${s('"sensor-a"')});`,
  `sensor.increment_by(${n('142')});`,
  '',
  `${k('let mut')} gateway = GCounter::new(${s('"gateway"')});`,
  '',
  `${c("// Delta: only send what the gateway doesn't have")}`,
  `${k('let')} delta = sensor.delta(&amp;gateway);`,
  'gateway.apply_delta(&amp;delta);',
  `${k('assert_eq!')}(gateway.value(), ${n('142')});`,
].join('\n');

const codeMigration = [
  `${k('use')} crdt_migrate::{crdt_schema, migration};`,
  '',
  `${p('#[crdt_schema(version = 1, table = "sensors")]')}`,
  `${k('struct')} SensorV1 { device_id: ${ty('String')}, temperature: ${ty('f32')} }`,
  '',
  `${p('#[crdt_schema(version = 2, table = "sensors")]')}`,
  `${k('struct')} SensorV2 { device_id: ${ty('String')}, temperature: ${ty('f32')}, humidity: Option&lt;${ty('f32')}&gt; }`,
  '',
  `${p('#[migration(from = 1, to = 2)]')}`,
  `${k('fn')} add_humidity(old: SensorV1) -&gt; SensorV2 {`,
  `  SensorV2 { device_id: old.device_id, temperature: old.temperature, humidity: None }`,
  '}',
  `${c('// v1 records auto-migrate to v2 on load')}`,
].join('\n');
---

<!-- ===== HERO ===== -->
<section class="relative pt-36 pb-20 text-center overflow-hidden">
  <div class="absolute inset-0 pointer-events-none" style="background-image: linear-gradient(rgba(48,54,61,0.25) 1px, transparent 1px), linear-gradient(90deg, rgba(48,54,61,0.25) 1px, transparent 1px); background-size: 60px 60px; mask-image: radial-gradient(ellipse 80% 70% at 50% 40%, black 20%, transparent 70%);"></div>
  <div class="absolute inset-0 pointer-events-none" style="background: radial-gradient(ellipse 600px 400px at 25% 15%, rgba(0,201,167,0.08), transparent 70%), radial-gradient(ellipse 500px 350px at 75% 25%, rgba(162,89,255,0.06), transparent 70%), radial-gradient(ellipse 400px 300px at 50% 85%, rgba(247,147,26,0.04), transparent 70%);"></div>

  <div class="relative max-w-4xl mx-auto px-6">
    <img src="https://raw.githubusercontent.com/crdt-kit/crdt-kit/master/assets/banner.png" alt="crdt-kit" class="mx-auto max-w-md w-full mb-5" />
    <p class="text-text-dim text-lg mb-2">{t(lang, 'hero.tagline')}</p>
    <p class="text-text-dim text-sm max-w-xl mx-auto mb-6 leading-relaxed">{t(lang, 'hero.sub')}</p>

    <div class="flex justify-center gap-2 flex-wrap mb-7">
      <img src="https://img.shields.io/crates/v/crdt-kit.svg?style=flat-square&logo=rust&color=e6522c" alt="crates.io" class="h-5" />
      <img src="https://img.shields.io/crates/d/crdt-kit.svg?style=flat-square&color=e6522c" alt="downloads" class="h-5" />
      <img src="https://img.shields.io/docsrs/crdt-kit?style=flat-square&logo=docs.rs&color=1a6fe6" alt="docs" class="h-5" />
      <img src="https://img.shields.io/github/actions/workflow/status/crdt-kit/crdt-kit/ci.yml?branch=master&style=flat-square&logo=github&label=CI" alt="ci" class="h-5" />
    </div>

    <div class="flex justify-center gap-3 flex-wrap mb-7">
      <a href="#quickstart" class="bg-teal text-bg font-semibold px-5 py-2.5 rounded-lg hover:bg-teal/90 transition-colors text-sm">{t(lang, 'hero.getstarted')}</a>
      <a href="https://docs.rs/crdt-kit" target="_blank" class="border border-purple/30 bg-purple/10 text-purple font-semibold px-5 py-2.5 rounded-lg hover:border-purple transition-colors text-sm">{t(lang, 'hero.apidocs')}</a>
      <a href="https://github.com/crdt-kit/crdt-kit" target="_blank" class="border border-border text-text font-semibold px-5 py-2.5 rounded-lg hover:border-text-dim transition-colors text-sm">GitHub</a>
    </div>

    <div class="inline-flex items-center gap-3 bg-bg-card border border-border rounded-lg px-5 py-2.5">
      <code class="text-teal text-sm">cargo add crdt-kit</code>
    </div>
  </div>
</section>

<!-- ===== DEVICE ANIMATION ===== -->
<section class="py-10 px-6">
  <DeviceAnimation />
</section>

<!-- ===== WHAT ===== -->
<section class="py-20 px-6" id="what">
  <div class="max-w-6xl mx-auto">
    <div class="max-w-3xl mx-auto text-center space-y-4 mb-12">
      <h2 class="text-3xl font-extrabold tracking-tight">{t(lang, 'what.title')}</h2>
      <p class="text-text-dim leading-relaxed">{t(lang, 'what.p1')}</p>
      <p class="text-text-dim leading-relaxed">{t(lang, 'what.p2')}</p>
      <p class="text-text-dim leading-relaxed">{t(lang, 'what.p3')}</p>
    </div>
    <MergeVisualization lang={lang} />
  </div>
</section>

<!-- ===== WHY (Stats) ===== -->
<section class="py-20 px-6 bg-bg-alt" id="why">
  <div class="max-w-6xl mx-auto text-center">
    <h2 class="text-3xl font-extrabold tracking-tight mb-3">{t(lang, 'why.title')}</h2>
    <p class="text-text-dim max-w-xl mx-auto mb-12">{t(lang, 'why.sub')}</p>
    <div class="flex justify-center gap-10 md:gap-16 flex-wrap">
      {[['~50KB', 'why.s1'], ['0', 'why.s2'], ['9', 'why.s3'], ['268', 'why.s4'], ['19M', 'why.s5']].map(([val, key]) => (
        <div class="text-center">
          <span class="block text-4xl font-extrabold text-teal tracking-tight">{val}</span>
          <span class="text-xs text-text-dim mt-1 block">{t(lang, key as any)}</span>
        </div>
      ))}
    </div>
  </div>
</section>

<!-- ===== FEATURES ===== -->
<section class="py-20 px-6" id="features">
  <div class="max-w-6xl mx-auto">
    <h2 class="text-3xl font-extrabold tracking-tight text-center mb-12">{t(lang, 'feat.title')}</h2>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {[
        ['no_std', 'feat.nostd', 'teal', 'M20 2H8a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V8z'],
        ['Delta Sync', 'feat.delta', 'orange', 'M13 2L3 14h9l-1 8 10-12h-9l1-8z'],
        ['WASM', 'feat.wasm', 'purple', 'M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 002 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0022 16z'],
        ['Migrations', 'feat.migrate', 'teal', 'M4 22h14a2 2 0 002-2V7.5L14.5 2H6a2 2 0 00-2 2v4'],
        ['Storage', 'feat.storage', 'orange', 'M12 2C6.48 2 2 4.69 2 5s4.48 3 10 3 10-2.69 10-3-4.48-3-10-3'],
        ['Codegen', 'feat.codegen', 'purple', 'M16 18l6-6-6-6M8 6l-6 6 6 6'],
        ['Serde', 'feat.serde', 'teal', 'M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z'],
        ['Events', 'feat.events', 'orange', 'M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z'],
        ['Dev Tools', 'feat.devtools', 'purple', 'M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z'],
      ].map(([title, key, color, d]) => (
        <div class="bg-bg-card border border-border rounded-xl p-5 hover:border-text-dim transition-all hover:-translate-y-0.5">
          <div class:list={['w-10 h-10 rounded-lg flex items-center justify-center mb-3', colorClasses(color as string, 'icon')]}>
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d={d as string}/></svg>
          </div>
          <h3 class="font-bold text-sm mb-1.5">{title}</h3>
          <p class="text-text-dim text-xs leading-relaxed">{t(lang, key as any)}</p>
        </div>
      ))}
    </div>
  </div>
</section>

<!-- ===== COMPARISON ===== -->
<section class="py-20 px-6 bg-bg-alt" id="comparison">
  <div class="max-w-6xl mx-auto">
    <h2 class="text-3xl font-extrabold tracking-tight text-center mb-12">{t(lang, 'compare.title')}</h2>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-border">
            <th class="text-left py-3 px-4 text-text-dim text-xs uppercase tracking-wider"></th>
            <th class="text-left py-3 px-4 text-teal text-xs uppercase tracking-wider font-bold">crdt-kit</th>
            <th class="text-left py-3 px-4 text-text-dim text-xs uppercase tracking-wider">Automerge</th>
            <th class="text-left py-3 px-4 text-text-dim text-xs uppercase tracking-wider">Yjs / Yrs</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-border">
          {[
            ['Language', 'Rust', 'Rust', 'JS / Rust'],
            ['Zero deps (core)', '\u2713', '30+', 'N/A'],
            ['no_std', '\u2713', '\u2717', '\u2717'],
            ['WASM', '\u2713', 'Partial', 'Native'],
            ['Storage', 'SQLite, redb, mem', 'Custom', 'N/A'],
            ['Migrations', 'Automatic', 'Manual', 'N/A'],
            ['Delta sync', '\u2713', '\u2713', '\u2713'],
            ['Event sourcing', '\u2713', '\u2717', '\u2717'],
            ['Code generation', '\u2713', '\u2717', '\u2717'],
            ['CLI', '\u2713', '\u2717', '\u2717'],
            ['Size', '~50KB', '~500KB+', '~150KB'],
          ].map(([label, ck, am, yjs]) => (
            <tr>
              <td class="py-2.5 px-4 font-medium text-text">{label}</td>
              <td class="py-2.5 px-4 text-teal font-semibold bg-teal/[0.03]">{ck}</td>
              <td class:list={['py-2.5 px-4', am === '\u2713' ? 'text-teal' : 'text-text-dim']}>{am}</td>
              <td class:list={['py-2.5 px-4', (yjs === '\u2713' || yjs === 'Native') ? 'text-teal' : 'text-text-dim']}>{yjs}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- ===== CRDT TYPES ===== -->
<section class="py-20 px-6" id="crdts">
  <div class="max-w-6xl mx-auto">
    <h2 class="text-3xl font-extrabold tracking-tight text-center mb-3">{t(lang, 'crdts.title')}</h2>
    <p class="text-text-dim text-center max-w-xl mx-auto mb-12">{t(lang, 'crdts.sub')}</p>

    {[
      { cat: lang === 'es' ? 'Contadores' : 'Counters', items: [
        { name: 'GCounter', badge: 'DeltaCrdt', bc: 'teal', desc: lang === 'es' ? 'Contador solo-crecimiento. Suma de todos los nodos.' : 'Grow-only counter. Sum of all nodes.', use: lang === 'es' ? 'Visitas, eventos IoT' : 'Page views, IoT events' },
        { name: 'PNCounter', badge: 'DeltaCrdt', bc: 'teal', desc: lang === 'es' ? 'Incremento y decremento. Par interno de GCounters.' : 'Increment & decrement. Internal GCounter pair.', use: lang === 'es' ? 'Inventario, likes' : 'Inventory, likes/dislikes' },
      ]},
      { cat: lang === 'es' ? 'Registros' : 'Registers', items: [
        { name: 'LWWRegister', badge: 'State', bc: 'dim', desc: lang === 'es' ? 'Last-Writer-Wins. Hybrid Logical Clock.' : 'Last-Writer-Wins. Hybrid Logical Clock.', use: lang === 'es' ? 'Perfiles, config, GPS' : 'Profiles, config, GPS' },
        { name: 'MVRegister', badge: 'State', bc: 'dim', desc: lang === 'es' ? 'Multi-valor. Preserva escrituras concurrentes.' : 'Multi-value. Preserves concurrent writes.', use: lang === 'es' ? 'Auditoria, versiones' : 'Audit trails, versions' },
      ]},
      { cat: lang === 'es' ? 'Conjuntos' : 'Sets', items: [
        { name: 'GSet', badge: 'State', bc: 'dim', desc: lang === 'es' ? 'Solo-crecimiento. Union al merge.' : 'Grow-only. Union on merge.', use: lang === 'es' ? 'IDs vistos, tags' : 'Seen IDs, tags' },
        { name: 'TwoPSet', badge: 'State', bc: 'dim', desc: lang === 'es' ? 'Add + remove permanente.' : 'Add + permanent remove.', use: lang === 'es' ? 'Blocklists, bans' : 'Blocklists, bans' },
        { name: 'ORSet', badge: 'DeltaCrdt', bc: 'teal', desc: lang === 'es' ? 'Add y remove libre. Add gana en concurrencia.' : 'Add & remove freely. Add wins on concurrent.', use: lang === 'es' ? 'Carritos, miembros' : 'Carts, members' },
      ]},
      { cat: lang === 'es' ? 'Secuencias' : 'Sequences', items: [
        { name: 'Rga', badge: 'State', bc: 'dim', desc: lang === 'es' ? 'Array replicado. Insert, remove, move.' : 'Replicated Growable Array. Insert, remove, move.', use: lang === 'es' ? 'Playlists, kanban' : 'Playlists, kanban' },
        { name: 'TextCrdt', badge: 'State', bc: 'dim', desc: lang === 'es' ? 'Texto colaborativo. insert_str(), remove_range(), fork().' : 'Collaborative text. insert_str(), remove_range(), fork().', use: lang === 'es' ? 'Edicion tipo Google Docs' : 'Google Docs-style editing' },
      ]},
    ].map(({ cat, items }) => (
      <div class="mb-6">
        <h3 class="text-xs uppercase tracking-widest text-text-dim mb-3">{cat}</h3>
        <div class:list={['grid gap-3', items.length === 3 ? 'sm:grid-cols-3' : 'sm:grid-cols-2']}>
          {items.map(({ name, badge, bc, desc, use: useCase }) => (
            <a href={'https://docs.rs/crdt-kit/latest/crdt_kit/struct.' + name + '.html'} target="_blank"
              class="block bg-bg-card border border-border rounded-xl p-5 hover:border-teal transition-all group">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-bold text-sm group-hover:text-teal transition-colors">{name}</h4>
                <span class:list={['text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded', bc === 'teal' ? 'bg-teal/10 text-teal' : 'bg-text-dim/10 text-text-dim']}>{badge}</span>
              </div>
              <p class="text-text-dim text-xs leading-relaxed mb-2">{desc}</p>
              <p class="text-text-dim text-[10px] italic">{useCase}</p>
            </a>
          ))}
        </div>
      </div>
    ))}
  </div>
</section>

<!-- ===== QUICK START ===== -->
<section class="py-20 px-6 bg-bg-alt" id="quickstart">
  <div class="max-w-4xl mx-auto">
    <h2 class="text-3xl font-extrabold tracking-tight text-center mb-12">{t(lang, 'qs.title')}</h2>

    <div class="grid md:grid-cols-2 gap-4 mb-8">
      <CodeBlock title="Cargo.toml" code={codeCargoToml} />
      <CodeBlock title="main.rs" code={codeMainRs} />
    </div>

    <h3 class="text-lg font-bold text-center mb-4">Delta Sync</h3>
    <CodeBlock title="delta_sync.rs" code={codeDeltaSync} />

    <h3 class="text-lg font-bold text-center mt-10 mb-4">Schema Migrations</h3>
    <CodeBlock title="migration.rs" code={codeMigration} />
  </div>
</section>

<!-- ===== ARCHITECTURE ===== -->
<section class="py-20 px-6" id="architecture">
  <div class="max-w-6xl mx-auto">
    <h2 class="text-3xl font-extrabold tracking-tight text-center mb-3">{t(lang, 'arch.title')}</h2>
    <p class="text-text-dim text-center max-w-xl mx-auto mb-12">{t(lang, 'arch.sub')}</p>
    <div class="flex flex-col md:flex-row justify-center items-stretch gap-4 mb-10">
      {[['1', 'arch.s1', 'arch.s1d'], ['2', 'arch.s2', 'arch.s2d'], ['3', 'arch.s3', 'arch.s3d']].map(([num, titleK, descK], i) => (
        <div class="contents">
          <div class="bg-bg-card border border-border rounded-xl p-6 max-w-[260px] text-center flex-1">
            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-teal/10 text-teal font-extrabold text-sm mb-3">{num}</span>
            <h4 class="font-bold mb-2">{t(lang, titleK as any)}</h4>
            <p class="text-text-dim text-xs leading-relaxed">{t(lang, descK as any)}</p>
          </div>
          {i < 2 && <span class="hidden md:flex items-center text-text-dim text-2xl">&rarr;</span>}
        </div>
      ))}
    </div>
  </div>
</section>

<!-- ===== USE CASES ===== -->
<section class="py-20 px-6 bg-bg-alt" id="usecases">
  <div class="max-w-6xl mx-auto">
    <h2 class="text-3xl font-extrabold tracking-tight text-center mb-12">{t(lang, 'use.title')}</h2>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {[
        ['use.iot', 'use.iotd', 'teal'],
        ['use.mobile', 'use.mobiled', 'orange'],
        ['use.collab', 'use.collabd', 'purple'],
        ['use.edge', 'use.edged', 'teal'],
        ['use.p2p', 'use.p2pd', 'orange'],
        ['use.wasmuc', 'use.wasmd', 'purple'],
      ].map(([titleKey, descKey, color]) => (
        <div class="bg-bg-card border border-border rounded-xl p-5 hover:border-text-dim transition-all hover:-translate-y-0.5">
          <div class:list={['w-2 h-2 rounded-full mb-3', colorClasses(color as string, 'dot')]}></div>
          <h3 class="font-bold text-sm mb-2">{t(lang, titleKey as any)}</h3>
          <p class="text-text-dim text-xs leading-relaxed">{t(lang, descKey as any)}</p>
        </div>
      ))}
    </div>
  </div>
</section>

<!-- ===== ECOSYSTEM ===== -->
<section class="py-20 px-6" id="ecosystem">
  <div class="max-w-6xl mx-auto">
    <h2 class="text-3xl font-extrabold tracking-tight text-center mb-3">{t(lang, 'eco.title')}</h2>
    <p class="text-text-dim text-center max-w-xl mx-auto mb-12">{t(lang, 'eco.sub')}</p>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {[
        ['crdt-kit', '9 CRDTs + HLC + traits', 'std \u00b7 serde \u00b7 wasm'],
        ['crdt-store', 'SQLite, redb, memory + CrdtDb', 'sqlite \u00b7 redb'],
        ['crdt-migrate', 'Version envelopes + migration engine', 'macros'],
        ['crdt-codegen', 'TOML schema \u2192 persistence layer', '\u2014'],
        ['crdt-cli', 'generate, dev-ui, inspect, compact, export', '\u2014'],
        ['crdt-dev-ui', 'Embedded dark-themed web inspector', '\u2014'],
      ].map(([name, desc, flags]) => (
        <a href={'https://crates.io/crates/' + name} target="_blank"
          class="block bg-bg-card border border-border rounded-xl p-5 hover:border-teal hover:-translate-y-0.5 transition-all text-text">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-mono font-bold text-sm">{name}</h3>
            <img src={'https://img.shields.io/crates/v/' + name + '?style=flat-square&color=00C9A7'} alt="" class="h-4" />
          </div>
          <p class="text-text-dim text-xs leading-relaxed mb-2">{desc}</p>
          <span class="text-text-dim text-[10px] italic">{flags}</span>
        </a>
      ))}
    </div>
  </div>
</section>

<!-- ===== INTERACTIVE DEMO ===== -->
<section class="py-20 px-6 bg-bg-alt" id="demo">
  <div class="max-w-6xl mx-auto">
    <h2 class="text-3xl font-extrabold tracking-tight text-center mb-3">{t(lang, 'demo.title')}</h2>
    <p class="text-text-dim text-center max-w-xl mx-auto mb-10">{t(lang, 'demo.sub')}</p>
    <InteractiveDemo client:visible />
  </div>
</section>

<!-- ===== PERFORMANCE ===== -->
<section class="py-20 px-6">
  <div class="max-w-6xl mx-auto">
    <h2 class="text-3xl font-extrabold tracking-tight text-center mb-3">{t(lang, 'perf.title')}</h2>
    <p class="text-text-dim text-center max-w-xl mx-auto mb-10">{t(lang, 'perf.sub')}</p>

    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
      {[
        ['19M', 'ops/sec', 'GCounter increment',
          lang === 'es' ? 'Incrementar un contador distribuido. La operación más básica y frecuente.' : 'Incrementing a distributed counter. The most basic and frequent operation.',
          '53 μs / 1000 ops', 'teal',
          lang === 'es'
            ? 'Se crea un GCounter con un nodo y se llama .increment() 1000 veces consecutivas. Se mide el tiempo total. Un GCounter es un mapa {nodo → cantidad}. Cada increment solo suma 1 a su propio slot — O(1), sin locks.'
            : 'Creates a GCounter with one node and calls .increment() 1000 times consecutively. Measures total time. A GCounter is a map {node → count}. Each increment only adds 1 to its own slot — O(1), no locks.'],
        ['9M', 'merges/sec', 'GCounter merge',
          lang === 'es' ? 'Fusionar 10 réplicas. Simula 10 dispositivos reconectando a la vez.' : 'Merging 10 replicas. Simulates 10 devices reconnecting at once.',
          '1.1 μs / 10 replicas', 'teal',
          lang === 'es'
            ? 'Se crean 10 GCounters con diferentes nodos, cada uno incrementado varias veces. Se fusionan todos en uno. Merge toma el max() de cada slot — si nodo-A tiene {a:5, b:0} y nodo-B tiene {a:0, b:3}, el resultado es {a:5, b:3}. Tiempo lineal respecto al número de nodos.'
            : 'Creates 10 GCounters with different nodes, each incremented multiple times. Merges them all into one. Merge takes max() of each slot — if node-A has {a:5, b:0} and node-B has {a:0, b:3}, result is {a:5, b:3}. Linear time in number of nodes.'],
        ['16M', 'ops/sec', 'PNCounter inc+dec',
          lang === 'es' ? 'Contador con incremento y decremento. Para inventarios y likes.' : 'Counter with increment & decrement. For inventory tracking and likes.',
          '60 μs / 1000 ops', 'orange',
          lang === 'es'
            ? 'PNCounter = dos GCounters internos: uno para incrementos (P) y otro para decrementos (N). valor = P - N. Se hacen 500 incrementos y 500 decrementos intercalados. Cada operación es O(1) — solo modifica un slot del GCounter interno correspondiente.'
            : 'PNCounter = two internal GCounters: one for increments (P) and one for decrements (N). value = P - N. Does 500 increments and 500 decrements interleaved. Each operation is O(1) — only modifies one slot in the corresponding internal GCounter.'],
        ['5M', 'ops/sec', 'ORSet insert',
          lang === 'es' ? 'Insertar en un conjunto replicado. Para carritos de compra, listas.' : 'Inserting into a replicated set. For shopping carts, lists.',
          '187 μs / 1000 ops', 'orange',
          lang === 'es'
            ? 'Se crea un ORSet vacío y se insertan 1000 elementos distintos. Cada insert genera un tag único (nodo + reloj lógico) para rastrear el elemento. En merge, "add gana" sobre remove concurrente — si Alice agrega "leche" y Bob lo borra simultáneamente, "leche" queda.'
            : 'Creates an empty ORSet and inserts 1000 distinct elements. Each insert generates a unique tag (node + logical clock) to track the element. On merge, "add wins" over concurrent remove — if Alice adds "milk" and Bob removes it simultaneously, "milk" stays.'],
        ['191 μs', 'merge 500+500', 'ORSet merge',
          lang === 'es' ? 'Fusionar dos conjuntos de 500 elementos. Peor caso realista.' : 'Merging two sets of 500 elements. Realistic worst-case scenario.',
          '1000 elements total', 'purple',
          lang === 'es'
            ? 'Dos ORSets, cada uno con 500 elementos (algunos compartidos, algunos únicos). El merge une los tags de ambos conjuntos. Un elemento solo se elimina si todas sus tags han sido removidas. El merge es proporcional al tamaño total de ambos conjuntos.'
            : 'Two ORSets, each with 500 elements (some shared, some unique). Merge unions the tags of both sets. An element is only removed if all its tags have been deleted. Merge time is proportional to the total size of both sets.'],
        ['8M', 'merges/sec', 'LWWRegister merge',
          lang === 'es' ? 'Last-Writer-Wins: el valor más reciente gana. Para perfiles, config, GPS.' : 'Last-Writer-Wins: most recent value wins. For profiles, config, GPS.',
          '11.5 μs / 100 replicas', 'purple',
          lang === 'es'
            ? 'LWWRegister guarda un valor + timestamp (Hybrid Logical Clock). Al merge, gana el timestamp más alto. Se crean 100 registros con diferentes valores y timestamps, se fusionan todos. El merge es una simple comparación de timestamps — O(1) por par.'
            : 'LWWRegister stores a value + timestamp (Hybrid Logical Clock). On merge, highest timestamp wins. Creates 100 registers with different values and timestamps, merges them all. Merge is a simple timestamp comparison — O(1) per pair.'],
      ].map(([val, unit, title, desc, detail, color, howItWorks]) => (
        <details class="group bg-bg-card border border-border rounded-xl hover:border-text-dim transition-all">
          <summary class="p-5 cursor-pointer list-none">
            <div class="flex items-baseline gap-1.5 mb-2">
              <span class:list={['text-2xl font-extrabold tracking-tight', color === 'teal' ? 'text-teal' : color === 'orange' ? 'text-orange' : 'text-purple']}>{val}</span>
              <span class="text-text-dim text-xs font-mono">{unit}</span>
            </div>
            <h3 class="font-bold text-sm mb-1.5">{title}</h3>
            <p class="text-text-dim text-xs leading-relaxed mb-2">{desc}</p>
            <div class="flex items-center justify-between">
              <span class="text-text-dim text-[10px] font-mono">{detail}</span>
              <span class="text-text-dim text-[10px] group-open:rotate-180 transition-transform">▼</span>
            </div>
          </summary>
          <div class="px-5 pb-5 pt-0 border-t border-border mt-0">
            <div class="pt-4">
              <p class="text-[10px] text-teal font-bold uppercase tracking-wider mb-1.5">{lang === 'es' ? '¿Cómo funciona esta prueba?' : 'How does this benchmark work?'}</p>
              <p class="text-text-dim text-xs leading-relaxed">{howItWorks}</p>
            </div>
          </div>
        </details>
      ))}
    </div>

    <p class="text-center text-text-dim text-xs">{lang === 'es' ? 'Medido con Criterion en builds optimizados (release). μs = microsegundos (millonésimas de segundo). Haz clic en cada card para ver cómo funciona.' : 'Measured with Criterion on optimized (release) builds. μs = microseconds (millionths of a second). Click any card to see how it works.'}</p>
  </div>
</section>

<!-- ===== GUARANTEES ===== -->
<section class="py-20 px-6 bg-bg-alt">
  <div class="max-w-6xl mx-auto">
    <h2 class="text-3xl font-extrabold tracking-tight text-center mb-3">{t(lang, 'guar.title')}</h2>
    <p class="text-text-dim text-center max-w-xl mx-auto mb-10">{t(lang, 'guar.sub')}</p>
    <div class="grid sm:grid-cols-3 gap-4">
      {[
        ['a \u2295 b = b \u2295 a', 'guar.comm', 'guar.commd'],
        ['(a \u2295 b) \u2295 c = a \u2295 (b \u2295 c)', 'guar.assoc', 'guar.assocd'],
        ['a \u2295 a = a', 'guar.idem', 'guar.idemd'],
      ].map(([sym, titleK, descK]) => (
        <div class="bg-bg-card border border-border rounded-xl p-6 text-center">
          <div class="font-mono text-teal text-lg mb-3">{sym}</div>
          <h3 class="font-bold text-sm mb-1">{t(lang, titleK as any)}</h3>
          <p class="text-text-dim text-xs">{t(lang, descK as any)}</p>
        </div>
      ))}
    </div>
  </div>
</section>

<!-- ===== CLI ===== -->
<section class="py-20 px-6">
  <div class="max-w-6xl mx-auto">
    <h2 class="text-3xl font-extrabold tracking-tight text-center mb-12">{t(lang, 'cli.title')}</h2>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {[
        ['status', 'crdt status app.db', lang === 'es' ? 'Vista general de la base de datos.' : 'Database overview: namespaces, keys, size.', 'M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 00-.94-2.61'],
        ['inspect', 'crdt inspect app.db sensor-42', lang === 'es' ? 'Detalle de entidad con event log.' : 'Entity detail with event log.', 'M15 12a3 3 0 11-6 0 3 3 0 016 0zM2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z'],
        ['compact', 'crdt compact app.db', lang === 'es' ? 'Snapshot + truncar event logs.' : 'Snapshot + truncate event logs.', 'M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h14a2 2 0 012 2v14a2 2 0 01-2 2zM16 3v4a1 1 0 01-1 1H9a1 1 0 01-1-1V3'],
        ['export', 'crdt export app.db --namespace sensors', lang === 'es' ? 'Exportar JSON.' : 'JSON export.', 'M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3'],
        ['generate', 'crdt generate --schema schema.toml', lang === 'es' ? 'Generar capa de persistencia.' : 'Generate persistence layer.', 'M16 18l6-6-6-6M8 6l-6 6 6 6'],
        ['dev-ui', 'crdt dev-ui app.db', lang === 'es' ? 'Panel web en localhost:4242.' : 'Web panel at localhost:4242.', 'M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z'],
      ].map(([label, cmd, desc, icon]) => (
        <div class="bg-bg border border-border rounded-xl overflow-hidden hover:border-text-dim transition-all hover:-translate-y-0.5 group">
          <div class="flex items-center gap-2 px-4 py-2 bg-bg-card border-b border-border">
            <span class="w-2 h-2 rounded-full bg-[#FF5F57]"></span>
            <span class="w-2 h-2 rounded-full bg-[#FEBC2E]"></span>
            <span class="w-2 h-2 rounded-full bg-[#28C840]"></span>
            <span class="ml-auto font-mono text-[10px] text-text-dim">{label}</span>
          </div>
          <div class="p-4">
            <div class="flex items-start gap-3 mb-3">
              <div class="w-8 h-8 rounded-lg bg-teal/10 flex items-center justify-center shrink-0 group-hover:bg-teal/15 transition-colors">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00C9A7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d={icon as string}/></svg>
              </div>
              <code class="font-mono text-xs text-teal leading-relaxed pt-1.5">$ {cmd}</code>
            </div>
            <p class="text-text-dim text-xs leading-relaxed pl-11">{desc}</p>
          </div>
        </div>
      ))}
    </div>
  </div>
</section>

<!-- ===== CTA ===== -->
<section class="py-24 px-6 text-center" style="background: radial-gradient(ellipse 500px 300px at 50% 50%, rgba(0,201,167,0.06), transparent 70%);">
  <h2 class="text-3xl font-extrabold tracking-tight mb-6">{t(lang, 'cta.title')}</h2>
  <div class="inline-flex items-center gap-3 bg-bg-card border border-border rounded-lg px-6 py-3 mb-6">
    <code class="text-teal text-base">cargo add crdt-kit --features serde</code>
  </div>
  <div class="flex justify-center gap-3 flex-wrap">
    <a href="https://docs.rs/crdt-kit" target="_blank" class="bg-teal text-bg font-semibold px-5 py-2.5 rounded-lg text-sm hover:bg-teal/90 transition">{t(lang, 'hero.apidocs')}</a>
    <a href="https://github.com/crdt-kit/crdt-kit" target="_blank" class="border border-border text-text font-semibold px-5 py-2.5 rounded-lg text-sm hover:border-text-dim transition">GitHub</a>
  </div>
</section>
