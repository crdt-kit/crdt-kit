#!/bin/sh
#
# crdt-kit pre-commit hook
# Runs all CI checks locally before allowing a commit.
# Mirrors: .github/workflows/ci.yml
#
# Install: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

passed=0
failed=0
total=0

run_check() {
    total=$((total + 1))
    name="$1"
    shift
    printf "${CYAN}[$total]${NC} ${BOLD}%s${NC} ... " "$name"
    if output=$("$@" 2>&1); then
        printf "${GREEN}PASSED${NC}\n"
        passed=$((passed + 1))
    else
        printf "${RED}FAILED${NC}\n"
        echo "$output" | tail -30
        echo ""
        failed=$((failed + 1))
    fi
}

echo ""
echo "========================================"
echo "  crdt-kit pre-commit checks"
echo "========================================"
echo ""

# 1. Format check
run_check "cargo fmt --check" cargo fmt --all -- --check

# 2. Clippy (all features, deny warnings)
run_check "cargo clippy (all features)" cargo clippy --all-targets --all-features -- -D warnings

# 3. Build (default features)
run_check "cargo build (default)" cargo build --quiet

# 4. Build (no_std)
run_check "cargo check (no_std)" cargo check --no-default-features --quiet

# 5. Build (serde feature)
run_check "cargo check (serde)" cargo check --features serde --quiet

# 6. Tests (all features)
run_check "cargo test (all features)" cargo test --all-features --quiet

# 7. Doc tests
run_check "cargo test --doc" cargo test --doc --quiet

# 8. Documentation builds without warnings
run_check "cargo doc (no warnings)" cargo doc --no-deps --all-features --quiet

# Summary
echo ""
echo "========================================"
if [ "$failed" -eq 0 ]; then
    printf "  ${GREEN}All $passed/$total checks passed!${NC}\n"
    echo "========================================"
    echo ""
    exit 0
else
    printf "  ${RED}$failed/$total checks FAILED${NC}\n"
    echo "========================================"
    printf "  ${YELLOW}Commit aborted. Fix the errors above and try again.${NC}\n"
    echo ""
    exit 1
fi
